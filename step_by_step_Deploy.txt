############## DESPLEGAR APLICACION FLASK CON GUNICORN & NGINX #####################

# Esto es para configurar Gunicorn como application server y 
# Nginx actuando como un front-end reverse proxy.
####################################################################################

#Copiar o clonar de github (este repositorio) archivos de app

#crear entorno virtual Python
cd apiDatosRef

#Crear ambiente Python virtual
sudo python3 -m venv venv

#activar ambiente virtual
source venv/bin/activate

#Para instalar paquetes a partir de archivo requirements.txt
pip install -r requirements.txt


############### Configurar servicio Gunicorn ###########################

#Crear archivo .service en directorio /etc/systemd/system para configurar servicio de Gunicorn para las peticiones de la API:
sudo nano /etc/systemd/system/api_datosref.service

#ingresar el siguiente contenido en el archivo:

[Unit]
Description=Instancia Gunicorn para atender peticiones de la API de Datos Referenciales
After=network.target

[Service]
User=root
Group=adm
WorkingDirectory=/opt/apiDatosRef/
Environment="PATH=/opt/apiDatosRef/venv/bin/"
ExecStart=/opt/apiDatosRef/venv/bin/gunicorn --workers 2 --bind unix:api_datosref.sock -m 007 wsgi:app

[Install]
WantedBy=multi-user.target

############### Para manejar servicio ###########################
sudo systemctl start api_datosref
sudo systemctl status api_datosref
sudo systemctl stop api_datosref

#para cuando se modifica el archivo de config del servicio
sudo systemctl daemon-reload

################################################################


#después de instalar nginx, se configura de la siguiente forma

sudo nano /etc/nginx/sites-available/api_datosref

#ingresar el siguiente contenido en el archivo:


server {
    listen 8000;
    server_name 127.0.0.1;

    location / {
        include proxy_params;
        proxy_pass http://unix:/opt/apiDatosRef/api_datosref.sock;
    }
}

#crear symlink hacia sites-enabled
sudo ln -s /etc/nginx/sites-available/api_datosref /etc/nginx/sites-enabled

#revisar en archivo de configuración de nginx el usuario seteado 
sudo nano /etc/nginx/nginx.conf


#chequear sintaxis con
sudo nginx -t

#reiniciar 
sudo service nginx restart




